---
title: "SimulatedNestedData"
author: "Matt Nolan"
date: "06/02/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


We want to simulate nested / hierarchical data and then use the simulated data to evaluate different model fitting strategies.

We want to simulate a measured parameter, param, that depends on position, pos. The 'real' relationship between param and pos is a line with intercept, int, and slope, slope.

When all subjects are identical the 'real' values of int and slope are the same for each subject.

When subjects differ, the 'real' values of int and slope are drawn from a distribution. In this case we'll use Gaussians with mean 1 and standard deviation, intersd_int and intersd_slope

For each simulated experiment, positions are drawn from a uniform random distribution seperately for each subject. The experimentally measured value of param is then estimted from a Gaussian distribution with mean equal to the real value of param for that location, and standard deviation equal determined from the intra-animal variance term, intrasd.

Set random number seed so figures are reproducible.
```{r}
set.seed(1)
```


First, a function to make the 'real' values for each subject. 
```{r cars}
make_real_vals <- function(n_subjects, intersd_int = 1, intersd_slope = 1){
  tb <- tibble(id = 1:n_subjects, int = rnorm(n_subjects, 1, intersd_int), slope = rnorm(n_subjects, 1, intersd_slope))
  tb
}
```


Make groups with and without inter-subject variation.
```{r}
with_var_gp <- make_real_vals(20, 0.2, 0.2)
without_var_gp <- make_real_vals(20, 0, 0)
```


Next, a function to make an example dataset that might be obtained from the subjects. Returns a tidy formatted tibble.
```{r}
make_data <- function(subject_params, loc_n = 20, loc_max = 1, intrasd = 1) {
  total_points <- c(loc_n * count(with_var_gp))[[1]]
  tb <- tibble(id = rep(subject_params$id, loc_n),
               loc = rep(runif(total_points, 0, loc_max)),
               param = loc*subject_params$slope + subject_params$int + rnorm(total_points, 0, intrasd))
  tb
}
```


Make and plot simulated data with and wihout inter-subject variation.
```{r}
var_gp_format <- function(gg) {
  gg <- gg +
    ylim(0,3) +
    ylab("Param") +
    xlab("Pos") +
    theme(axis.text = element_blank())
}

with_var_gp_data <- make_data(with_var_gp, 20, 1, 0.2)
with_var_gp_gg <-ggplot(with_var_gp_data, aes(loc, param, group = id)) +
  geom_point(aes(colour = id)) +
  stat_smooth(geom = "line", method = lm, se = FALSE)

(with_var_gp_gg <- var_gp_format(with_var_gp_gg))

without_var_gp_data <- make_data(without_var_gp, 20, 1, 0.5)
without_var_gp_gg <- ggplot(without_var_gp_data, aes(loc, param, group = id)) +
  geom_point(aes(colour = id)) +
  stat_smooth(geom = "line", method = lm, se = FALSE) +
  ylim(0,3)

(without_var_gp_gg <- var_gp_format(without_var_gp_gg))
```

Fit mixed effect models to the datasets.
```{r}
with_var_gp_mm <- lmer(param ~ loc + (loc||id), data = with_var_gp_data, REML = FALSE)

without_var_gp_mm <- lmer(param ~ loc + (loc||id), data = without_var_gp_data, REML = FALSE)
```

Extract marginal and conditional R2 for each mixed model fit.
```{r}
(with_R2 <- r.squaredGLMM(with_var_gp_mm))
(without_R2 <- r.squaredGLMM(without_var_gp_mm))
```

Plot fits
```{r}
mm_with_predictplot <- predict_plot(with_var_gp_data, with_var_gp_mm, with_var_gp_data$loc, with_var_gp_data$param)

(mm_with_predictplot <- var_gp_format(mm_with_predictplot) +
    annotate("text", x = 0.7, y = 0.5, label = "paste(italic(R) ^ 2, \"marginal = .49\")", parse = TRUE) +
    annotate("text", x = 0.7, y = 0.2, label = "paste(italic(R) ^ 2, \"conditional = .73\")", parse = TRUE))

mm_without_predictplot <- predict_plot(without_var_gp_data, without_var_gp_mm, without_var_gp_data$loc, without_var_gp_data$param)

(mm_without_predictplot <- var_gp_format(mm_without_predictplot) +
    annotate("text", x = 0.7, y = 0.5, label = "paste(italic(R) ^ 2, \"marginal = .31\")", parse = TRUE) +
    annotate("text", x = 0.7, y = 0.2, label = "paste(italic(R) ^ 2, \"conditional = .31\")", parse = TRUE))


```


