---
title: "ModifiedGapStatistic"
author: "Matt Nolan"
date: "28/02/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source("ModifiedGap_Functions.R")
```

## Modified gap statistic

Goal is to reimplement matlab code written by Hugh.

```{r}
K.max <- 8
```

Generate gap statistics and calculate significance threshold for simulated uniform distributions. Use these simulated data to calculate threshold values for detection of 'signficant' modes.
```{r}
# Parameters
n_sim <- 1000 # Use ≤ 20 for testing code. Use ≥ 500 for analyses.
n_cells <- length(test_data$id) # Number of cells in the dataset.

# Find all unique dataset lengths ≥ 30.
exp_numbers <- data.sc %>% group_by(id) %>% summarise(n()) %>% select(-id) %>% unique()

# Generate simulated gap data. If n_sim is high this will take a long time to run.
# Will look for a loaded version of sim_tib, then for a saved verion.
# If it finds neither then will build sim_tib.
if(exists("sim_tib")){
  print("sim_tib already generated, remove it if you want to rebuild or reload it")
  } else {
    if (file.exists("sim_distributions.Rda")) {
      load("sim_distributions.Rda")
      } else {
        sim_tib <- tibble(cell_count = exp_numbers[[1]]) %>%
          mutate(sims = pmap(list(cell_count, K.max, n_sim), gap_uniform_sim))
      }
  }

# Write sim_tib to file.
save(sim_tib, file = "sim_distributions.Rda")

# Calculate cut off values from the data
sim_tib <- mutate(sim_tib,
                  threshold_vals = map2(sims, 0.95, calc_thresholds)
                  )
```

Calculate gap statistics, gap differences and K_est for all features for all animals.
```{r}
# Re-organise all-data by id
all_data_r <- data.sc %>%
  group_by(id) %>%
  nest()

# add column with numbers of observations for each group
all_data_r$n <- data.sc %>% group_by(id) %>% summarise(n()) %>% select(-id)
all_data_r <- filter(all_data_r, n >= 30)

# Add thresholds to all_data_r.
all_data_r$sim_vals = list("")
for (i in 1:length(all_data_r$id)) {
  all_data_r$sim_vals[[i]] <- filter(sim_tib, cell_count == as.numeric(all_data_r$n[i,]))
}

# Calculate gap statistics. Restricts analyses to n ≥ 30.
all_data_r <- filter(all_data_r, n >= 30) %>%
  mutate(clusGap = pmap(list(data, sim_vals, K.max), clusGap_AllData))

# Extract k_est values for each mouse into a higher level column.
all_data_r <- mutate(all_data_r, K_est = map(clusGap, function(x) x[[4]]))


K_est_all_animals <- unnest(select(all_data_r, id, K_est))
K_est_all_animals$feature <- all_data_r$clusGap[[1]]$property
K_est_all_animals <- spread(K_est_all_animals, feature, K_est)

kableExtra::kable(K_est_all_animals) %>% kableExtra::kable_styling(bootstrap_options = "striped")
```

Check where clusGap is finding the thresholds. Seems like this needs to be passed to it.
    

Plot data and gap statistic analyses for a given cell and feature.
```{r}
(rheo_plot <- ggplot(test_data, aes(dvlocmm, rheo)) +
  geom_point())

# To do: add colour coded clusters.
data_plot <- function(df, mouse, feature){
  data_to_plot <- filter(df, id == mouse) %>% select(data)
  ggplot(data_to_plot$data[[1]], aes(dvloc, !! rlang::sym(feature))) +
    geom_point()
}

(rheo_plot <- data_plot(all_data_r, "mouse_20140522", "rheo"))

rheo_gap <- clusGap_Extra(test_data$rheo, K_max = K.max)

(rheo_logW_plot <- logW_plot(rheo_gap))

(rheo_gap_plot <- gap_plot(rheo_gap))
```


Calculate delta gap for real and simulated data and then compare.
```{r}
rheo_diff = tibble(clus_num = c(2:(K.max)), gap_diff = diff(rheo_gap$gap))

rheo_diff$gap_thresh <- threshold_vals

(rheo_diff_plot <- diff_plot(rheo_diff))
```

Repeat analyses for resonance frequency.
Plot data, calculate gap statistic up to K.max and plot.
```{r}
(resf_plot <- ggplot(test_data, aes(dvlocmm, resf)) +
  geom_point())

resf_gap <- clusGap_Extra(test_data$resf, K_max = K.max)

(resf_logW_plot <- logW_plot(resf_gap))

(resf_gap_plot <- gap_plot(resf_gap))
```

Calculate delta gap for real and simulated data and then compare.
```{r}
resf_diff = tibble(clus_num = c(2:(K.max)), gap_diff = diff(resf_gap$gap))

resf_diff$gap_thresh <- threshold_vals

(resf_diff_plot <- diff_plot(resf_diff))
```
