---
title: "Inter-animal variability"
author: "Matt Nolan"
date: "13/04/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Ensure access to libraries
library(lme4)
library(MuMIn)
library(tidyverse)
library(ggpubr)
library(corrplot)
library(modelr)
```

## Goals

To evaluate interanimal differences in properties of L2SCs.

Specific properties for filtering data. Include animals ≥ 28 days.
```{r}
min_age <- 0
```

Import the data, remove rows with unknown locations and summarise numbers of observations and animals. 
```{r import data, message = FALSE}
# fname.sc <- "/Users/hughpastoll/Research/stellateintrinsic/Database/datatable.txt"
fname.sc <- "/Users/mattnolan/Dropbox/Modules_data/stellateintrinsic/Database/datatable.txt"
data.import <- read_tsv(fname.sc)

# Strip out rows from data where locations are unknown (are NaN)
data.sc <- data.import %>% drop_na(dvloc)

# Keep animals ≥ min_age
data.sc.old <- filter(data.sc, age >= min_age)

# Calculate total number of observations, and number in each environment
length(data.sc.old$housing)
count(data.sc.old, housing)

# Calculate number of observations per animal
counts.old <- data.sc.old %>% count(id)
summary(counts.old)
```

Set up storage for model comparison p-values, pseudo r2 values and slopes
```{r setup storage}
results_model_housing <- tibble(measure = c("vm","ir","sag","tau","resf","resmag","spkthr","spkmax","spkhlf","rheo","ahp","fi"), p.val.comp = NaN, marginal.r2 = NaN, conditional.r2 = NaN, gradient.slopes = NaN, AIC_vsris = NaN, AIC_vsris_housing = NaN)
```


Convert dvloc from microns to millimetres - prevents errors in model fitting large dv values
```{r}
data.sc <- mutate(data.sc, dvlocmm = dvloc/1000)
```

Normalise property measurements.
```{r}
normalize<-function(m){
   (m - min(m, na.rm = TRUE))/(max(m, na.rm = TRUE)-min(m, na.rm = TRUE))
}

data.sc.norm <- as.data.frame(lapply(data.sc.old[1:12], normalize))
data.sc.norm$dvlocmm <- data.sc$dvlocmm
data.sc.norm$id <- data.sc$id

```

Loop through the data.
1. Create a model for each measured parameter.
2. Store plots for fitted slopes for each mouse.


```{r}
# reformat data
data.sc.norm_r <- data.sc.norm %>%
  select(vm:ahp, dvlocmm, id) %>%
  gather("property", "value", vm:ahp) %>%
  group_by(property) %>%
  nest()

# apply lmer to all measurements
model_to_fit <- function(df) {
  lmer(value ~ dvlocmm +(1+dvlocmm||id), data = df, REML = FALSE)
}
data.sc.norm_r <- data.sc.norm_r %>%
  mutate(mixedmodel = map(data, model_to_fit))

# add predictions
data.sc.norm_r <- data.sc.norm_r %>%
  mutate(fit = map(mixedmodel, predict))

# add model metrics
data.sc.norm_r <- data.sc.norm_r %>%
  mutate(glance = map(mixedmodel, broom::glance))

# extract data and fit values
data.sc.norm_r_fit <- data.sc.norm_r %>%
  unnest(data, fit)

# make plots
ggplot(data.sc.norm_r_fit, aes(x = dvlocmm, y = value)) +
  geom_point(alpha = 0.05) +
  geom_line(aes(y=fit, group = id), size=0.8, alpha = 0.5) +
  facet_wrap(~property)


```



