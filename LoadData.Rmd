---
title: "LoadData"
author: "Matt Nolan"
date: "02/05/2018"
output: html_document
---
```{r setup_LoadData, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Ensure access to libraries
library(lmerTest)
library(tidyverse)
```

# Load data {-}

To load and preprocess data used for other analyses.


Import the data.
```{r import data, message = FALSE}
fname.sc <- "datatable.txt"
data.import <- read_tsv(fname.sc)

# Strip out rows from data where locations are unknown (are NaN)
data.sc <- data.import %>% drop_na(dvloc)

# Convert dvloc from microns to millimetres - prevents errors in model fitting large dv values
data.sc <- mutate(data.sc, dvlocmm = dvloc/1000)
```

Total number of cells recorded, and number in each environment:
```{r}
length(data.sc$housing)
count(data.sc, housing)
```

Number of cells recorded per animal:
```{r}
counts <- data.sc %>% count(id)
summary(counts)
```


Add new columns containing copula transformed data
```{r}
trans.properties <- 
    apply(apply(data.sc %>% dplyr::select(vm:fi), 2, edf), 2, qnorm )
data.sc <- bind_cols(data.sc, as.data.frame(trans.properties))
```



Data is in a 'flat' format:
```{r}
head(data.sc)
```


Reformat data for use with map and other tidyverse functions. Properties vm:fi are the experimentally measured proprties, and vm1:fi1 are the transformed properties.
```{r}
data.sc_r <- data.sc %>%
  dplyr::select(vm:fi, vm1:fi1, dvlocmm, id, housing, id, mlpos, hemi, age, housing, expr, patchdir, rectime) %>%
  gather("property", "value", vm:fi1) %>%
  group_by(property) %>%
  nest()
```

Now the data is organised as a frame containing nested frames for each measurement:
```{r}
head(data.sc_r)
```

The nested frame for membrane potential (vm) looks like this:
```{r}
head(filter(data.sc_r, property == "vm")$data)
```


