---
title: "R Notebook"
output: html_notebook
---

```{r setup_Feates_FixedEffects, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Ensure access to libraries
library(lme4)
library(MuMIn)
library(tidyverse)
```

# Evaluation of impact of additional fixed effects

## Do SC properties depend on age, housing, or experimental procedures?

Does including other parameters improve the model or alter conclusions derived from the model? Parameters to consider: housing, mlposition, hemisphere, age, experimenter, patch-direction, recording time.

Should parameters be added as fixed or randomw effects? We take this definition from Gelman (2004), "We define effects (or coefficients) in a multilevel model as constant if they are identical for all groups in a population and varying if they are allowed to differ from group to group." See also discussion here: 
https://stats.stackexchange.com/questions/4700/what-is-the-difference-between-fixed-effect-random-effect-and-mixed-effect-mode. From this discussion (answer from Ben Bolker), "You usually canâ€™t use random effects when the grouping variable has fewer than five levels, and random effects variance estimates are unstable with fewer than eight levels, because you are trying to estimate a variance from a very small sample". See also: http://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#model-specification.

On this bases additional parameters are all fixed effects.

We will adopt strategy of first evaluating each fixed effect and it's possible interaction with dvlocmm. Later on we will consider possible interactions. For these analyses we use type II ANOVA provided by the car package.

This code requires first running Props_mixed_model.Rmd.


All ages.
```{r}
data.sc_r <- data.sc_r %>%
  mutate(mm_age = map(data, model_vsris_age))

data.sc_r <- summary_2fixedeffects(data.sc_r, mm_age, "age")

data.sc_r$mm_age_dv_adj <- p.adjust(data.sc_r$mm_age_dv, method = "BH")
data.sc_r$mm_age_age_adj <- p.adjust(data.sc_r$mm_age_age, method = "BH")
data.sc_r$mm_age_dv_age_adj <- p.adjust(data.sc_r$mm_age_dv_age, method = "BH")

age_table <- FE_table(data.sc_r, "age")

age_table
```

Look at fixed effects for IR, sag resonant frequncy and resonance magnitude.
```{r}
plotFE_sd(filter(data.sc_r, property == "ir")$mm_age[[1]]) +
  ggtitle("Fixed effects for input resistance")

plotFE_sd(filter(data.sc_r, property == "sag")$mm_age[[1]]) +
  ggtitle("Fixed effects for the sag response")

plotFE_sd(filter(data.sc_r, property == "resf")$mm_age[[1]]) +
  ggtitle("Fixed effects for membrane resonance frequency")

plotFE_sd(filter(data.sc_r, property == "resmag")$mm_age[[1]]) +
  ggtitle("Fixed effects for Vm")

```


Look at age including only animals above P32.
```{r}
data.sc_r_f <- filter(data.sc, age > 32) %>%
  dplyr::select(vm:fi, dvlocmm, id, housing, id, mlpos, hemi, age, housing, expr, patchdir, rectime) %>%
  gather("property", "value", vm:fi) %>%
  group_by(property) %>% 
  nest()

data.sc_r_f <- data.sc_r_f  %>%
  mutate(mm_vsris_age = map(data, model_vsris_age))

data.sc_r_f <- summary_2fixedeffects(data.sc_r_f, mm_vsris_age, "age")

data.sc_r_f$mm_age_dv_adj <- p.adjust(data.sc_r_f$mm_age_dv, method = "BH")
data.sc_r_f$mm_age_age_adj <- p.adjust(data.sc_r_f$mm_age_age, method = "BH")
data.sc_r_f$mm_age_dv_age_adj <- p.adjust(data.sc_r_f$mm_age_dv_age, method = "BH")

age_f_table <- FE_table(data.sc_r_f, "age")

age_f_table
  
```

Look at fixed effects for Vm, IR and sag and resonance frequency.
```{r}
plotFE_sd(filter(data.sc_r_f, property == "vm")$mm_vsris_age[[1]]) +
  ggtitle("Fixed effects for Vm")

plotFE_sd(filter(data.sc_r_f, property == "ir")$mm_vsris_age[[1]]) +
  ggtitle("Fixed effects for input resistance")

plotFE_sd(filter(data.sc_r_f, property == "sag")$mm_vsris_age[[1]]) +
  ggtitle("Fixed effects for the sag response")

plotFE_sd(filter(data.sc_r_f, property == "resf")$mm_vsris_age[[1]]) +
  ggtitle("Fixed effects for membrane resonance frequency")
```

Look at age including only animals above P32 and below P45.
```{r}
data.sc_r_f2 <- filter(data.sc, age > 32 & age < 45) %>%
  dplyr::select(vm:fi, dvlocmm, id, housing, id, mlpos, hemi, age, housing, expr, patchdir, rectime) %>%
  gather("property", "value", vm:fi) %>%
  group_by(property) %>%
  nest()


data.sc_r_f2 <- data.sc_r_f2  %>%
  mutate(mm_vsris_age = map(data, model_vsris_age)) 

data.sc_r_f2 <- data.sc_r_f2  %>%
  mutate(mm_age = map(data, model_vsris_age))

data.sc_r_f2 <- summary_2fixedeffects(data.sc_r_f2, mm_age, "age")

data.sc_r_f2$mm_age_dv_adj <- p.adjust(data.sc_r_f2$mm_age_dv, method = "BH")
data.sc_r_f2$mm_age_age_adj <- p.adjust(data.sc_r_f2$mm_age_age, method = "BH")
data.sc_r_f2$mm_age_dv_age_adj <- p.adjust(data.sc_r_f2$mm_age_dv_age, method = "BH")

age_f2_table <- FE_table(data.sc_r_f2, "age")

age_f2_table
```

Look at fixed effects.
```{r}
plotFE_sd(filter(data.sc_r_f2, property == "vm")$mm_vsris_age[[1]]) +
  ggtitle("Fixed effects for Vm")

plotFE_sd(filter(data.sc_r_f2, property == "ir")$mm_vsris_age[[1]]) +
  ggtitle("Fixed effects for input resistance")

plotFE_sd(filter(data.sc_r_f2, property == "sag")$mm_vsris_age[[1]]) +
  ggtitle("Fixed effects for the sag response")

plotFE_sd(filter(data.sc_r_f2, property == "resf")$mm_vsris_age[[1]]) +
  ggtitle("Fixed effects for membrane resonance frequency")
```



Combined table for age. Including n and N.
```{r}
df_age_table <- cbind(select(data.sc_r,
                         property,
                         mm_age_dv_adj,
                         mm_age_age_adj,
                         mm_age_dv_age_adj,
                         mm_age_ngrps,
                         mm_age_nobs),
                      select(data.sc_r_f,
                         mm_age_dv_adj,
                         mm_age_age_adj,
                         mm_age_dv_age_adj,
                         mm_age_ngrps,
                         mm_age_nobs),
                      select(data.sc_r_f2,
                         mm_age_dv_adj,
                         mm_age_age_adj,
                         mm_age_dv_age_adj,
                         mm_age_ngrps,
                         mm_age_nobs))

df_age_table <- format(df_age_table, digits = 3)

(df_age_table <- kableExtra::kable(df_age_table,  col.names = c("property", rep(c("dvloc", "age", "dvloc:age", "N", "n"), 3)), digits = c(NA, rep(6,15))) %>%
  kableExtra::add_header_above(c(" " = 1, "All ages" = 5, "P32 < age" = 5, "P32 < age < P45" = 5)) %>%
  kableExtra::kable_styling(bootstrap_options = "striped")) 

df_age_table %>% kableExtra::save_kable(file = "TableS2.html", self_contained = T)
```

For analyses below exclude the p18 animal.

## Housing.
We're obtaining ngrps and nobs via summary. Could also do this by calling ngrps(model) and nobs(model), but produces an error that I can't figure out.
```{r}
data.sc_r_f2 <- data.sc_r_f2 %>%
  mutate(mm_vsris_housing = map(data, model_vsris_housing))

data.sc_r_f2 <- summary_2fixedeffects(data.sc_r_f2, mm_vsris_housing, "housing")

data.sc_r_f2$mm_housing_dv_adj <- p.adjust(data.sc_r_f2$mm_housing_dv, method = "BH")
data.sc_r_f2$mm_housing_housing_adj <- p.adjust(data.sc_r_f2$mm_housing_housing, method = "BH")
data.sc_r_f2$mm_housing_dv_housing_adj <- p.adjust(data.sc_r_f2$mm_housing_dv_housing, method = "BH")

(housing_table <- FE_table(data.sc_r_f2, "housing"))

housing_table %>%
  kableExtra::save_kable(file = "TableS3.html", self_contained = T)
```

Look at fixed effects for sag and spike half-width.
```{r}
plotFE_sd(filter(data.sc_r_f2, property == "sag")$mm_vsris_housing[[1]]) +
  ggtitle("Fixed effects for the sag response")

plotFE_sd(filter(data.sc_r_f2, property == "spkhlf")$mm_vsris_housing[[1]]) +
  ggtitle("Fixed effects for the spike half-width")
```


Plot sag intecept and slope.
```{r}
Sag_housing_intercepts <- ggplot(filter(combined_intercepts_slopes, property == "sag" & measure == "ind_intercept" & age > 32 & age < 45), aes(x = housing, y = value_2, colour = housing)) +
  geom_jitter(width = 0.1) +
  labs(y = "Sag", x = "Housing") +
  theme(legend.position="none")

Sag_housing_slopes <- ggplot(filter(combined_intercepts_slopes, property == "sag" & age > 32 & age < 45), aes(x = measure, y = value_1, colour = housing)) +
  geom_line(aes(group = id)) +
  geom_jitter(aes(y = value_2), width = 0.2) +
  scale_x_discrete(limits = c("ind_intercept", "ind_intercept_slope", "global_intercept", "global_intercept_slope"), label = c("I", "I + S", "", "")) +
  theme_classic() +
  hist_theme +
  theme(axis.line.x = element_blank(), axis.ticks.x = element_blank())

Sag_housing_intercepts
Sag_housing_slopes

ggsave("housingplot.png", width = 100, height = 50, units = "mm")
```



## Mediolateral position.
```{r}
data.sc_r_f2 <- data.sc_r_f2 %>%
  mutate(mm_vsris_ml = map(data, model_vsris_ml))

data.sc_r_f2 <- summary_2fixedeffects(data.sc_r_f2, mm_vsris_ml, "ml")

data.sc_r_f2$mm_ml_dv_adj <- p.adjust(data.sc_r_f2$mm_ml_dv, method = "BH")
data.sc_r_f2$mm_ml_ml_adj <- p.adjust(data.sc_r_f2$mm_ml_ml, method = "BH")
data.sc_r_f2$mm_ml_dv_ml_adj <- p.adjust(data.sc_r_f2$mm_ml_dv_ml, method = "BH")

(ml_table <- FE_table(data.sc_r_f2, "ml"))

ml_table %>% kableExtra::save_kable(file = "TableS4.html", self_contained = T)

```

Look at fixed effects for IR, sag, membrane time constant, resf and spike AHP.
```{r}
plotFE_sd(filter(data.sc_r_f2, property == "ir")$mm_vsris_ml[[1]]) +
  ggtitle("Fixed effects for IR")

plotFE_sd(filter(data.sc_r_f2, property == "sag")$mm_vsris_ml[[1]]) +
  ggtitle("Fixed effects for membrane potential sag")

plotFE_sd(filter(data.sc_r_f2, property == "tau")$mm_vsris_ml[[1]]) +
  ggtitle("Fixed effects for membrane time constant")

plotFE_sd(filter(data.sc_r_f2, property == "resf")$mm_vsris_ml[[1]]) +
  ggtitle("Fixed effects for resonance frequency")

plotFE_sd(filter(data.sc_r_f2, property == "ahp")$mm_vsris_ml[[1]]) +
  ggtitle("Fixed effects for  spike AHP")

```

Compare medial with lateral sections.
```{r}
ggplot(filter(data.sc_r_f2, property == "ir")$data[[1]], aes(mlpos,value, colour = dvlocmm)) +
  geom_boxplot() +
  ggtitle("Input resistance")

ggplot(filter(data.sc_r_f2, property == "sag")$data[[1]], aes(mlpos,value, colour = dvlocmm)) +
  geom_boxplot() +
  ggtitle("Membrane potential sag")

ggplot(filter(data.sc_r_f2, property == "resf")$data[[1]], aes(mlpos,value, colour = dvlocmm)) +
  geom_boxplot() +
  ggtitle("Resonance frequency")
```

Look at all properties as a function of dorsoventral location.
```{r}
all_by_fac(select(data.sc, vm:fi, dvlocmm, mlpos), "mlpos")
```



## Hemisphere
```{r}
data.sc_r_f2 <- data.sc_r_f2 %>%
  mutate(mm_vsris_hemi = map(data, model_vsris_hemi))

data.sc_r_f2 <- summary_2fixedeffects(data.sc_r_f2, mm_vsris_hemi, "hemi")

data.sc_r_f2$mm_hemi_dv_adj <- p.adjust(data.sc_r_f2$mm_hemi_dv, method = "BH")
data.sc_r_f2$mm_hemi_hemi_adj <- p.adjust(data.sc_r_f2$mm_hemi_hemi, method = "BH")
data.sc_r_f2$mm_hemi_dv_hemi_adj <- p.adjust(data.sc_r_f2$mm_hemi_dv_hemi, method = "BH")

(hemi_table <- FE_table(data.sc_r_f2, "hemi"))

hemi_table %>% kableExtra::save_kable(file = "TableS5.html", self_contained = T)
```


Look at fixed effects for sag and resonance magnitude.
```{r}
plotFE_sd(filter(data.sc_r_f2, property == "sag")$mm_vsris_hemi[[1]]) +
  ggtitle("Fixed effects for membrane potential sag response")

plotFE_sd(filter(data.sc_r_f2, property == "resmag")$mm_vsris_hemi[[1]]) +
  ggtitle("Fixed effects for resonance magnitude")
```

Look at effect of properties plotted as a function of location.
```{r}
all_by_fac(select(data.sc, vm:fi, dvlocmm, hemi), "hemi")
```


## Experimenter
```{r}
data.sc_r_f2 <- data.sc_r_f2 %>%
  mutate(mm_vsris_exp = map(data, model_vsris_exp))

data.sc_r_f2 <- summary_2fixedeffects(data.sc_r_f2, mm_vsris_exp, "exp")

data.sc_r_f2$mm_exp_dv_adj <- p.adjust(data.sc_r_f2$mm_exp_dv, method = "BH") 
data.sc_r_f2$mm_exp_exp_adj <- p.adjust(data.sc_r_f2$mm_exp_exp, method = "BH")
data.sc_r_f2$mm_exp_dv_exp_adj <- p.adjust(data.sc_r_f2$mm_exp_dv_exp, method = "BH")

(exp_table <- FE_table(data.sc_r_f2, "exp"))
exp_table  %>% kableExtra::save_kable(file = "TableS6.html", self_contained = T)
```

Look at fixed effects for input resistance, resonance frequency and spike half-width.
```{r}
plotFE_sd(filter(data.sc_r_f2, property == "ir")$mm_vsris_exp[[1]]) +
  ggtitle("Fixed effects for input resistance")

plotFE_sd(filter(data.sc_r_f2, property == "resf")$mm_vsris_exp[[1]]) +
  ggtitle("Fixed effects for resonance frequency")

plotFE_sd(filter(data.sc_r_f2, property == "spkhlf")$mm_vsris_exp[[1]]) +
  ggtitle("Fixed effects for spike half-width")
```


Look at all properties separated by experimenter.
```{r}
all_by_fac(select(data.sc, vm:fi, dvlocmm, expr), "expr")
```


## Patch direction
```{r}
data.sc_r_f2 <- data.sc_r_f2 %>%
  mutate(mm_vsris_dir = map(data, model_vsris_dir)) 

data.sc_r_f2 <- summary_2fixedeffects(data.sc_r_f2, mm_vsris_dir, "dir")

names_in <- c("mm_dir_dv", "mm_dir_dir", "mm_dir_dv_dir")
names_adj <- c("mm_dir_dv_adj", "mm_dir_dir_adj", "mm_dir_dv_dir_adj")

data.sc_r_f2[names_adj] <- lapply(data.sc_r_f2[names_in], p.adjust, method = "BH")

(dir_table <- FE_table(data.sc_r_f2, "dir"))
dir_table  %>% kableExtra::save_kable(file = "TableS7.html", self_contained = T)
```

Look at fixed effects for membrane potential, membrane time constant and spike half-width.
```{r}
plotFE_sd(filter(data.sc_r_f2, property == "vm")$mm_vsris_dir[[1]]) +
  ggtitle("Fixed effects for membrane potential")

plotFE_sd(filter(data.sc_r_f2, property == "tau")$mm_vsris_dir[[1]]) +
  ggtitle("Fixed effects for membrane time constant")

plotFE_sd(filter(data.sc_r_f2, property == "spkhlf")$mm_vsris_dir[[1]]) +
  ggtitle("Fixed effects for spike half-width")
```

Look at all properties separated by patch direction.
```{r}
all_by_fac(select(data.sc, vm:fi, dvlocmm, patchdir), "patchdir")
```


## Recording time
```{r}
data.sc_r_f2 <- data.sc_r_f2 %>%
  mutate(mm_vsris_rect = map(data, model_vsris_rect)) 

data.sc_r_f2 <- summary_2fixedeffects(data.sc_r_f2, mm_vsris_rect, "rect")

data.sc_r_f2$mm_rect_dv_adj <- p.adjust(data.sc_r_f2$mm_rect_dv, method = "BH")
data.sc_r_f2$mm_rect_rect_adj <- p.adjust(data.sc_r_f2$mm_rect_rect, method = "BH")
data.sc_r_f2$mm_rect_dv_rect_adj <- p.adjust(data.sc_r_f2$mm_rect_dv_rect, method = "BH")

rect_table <- FE_table(data.sc_r_f2, "rect")
rect_table
```

Look at fixed effects for membrane potential, resonance frquency and spike threshold.
```{r}
plotFE_sd(filter(data.sc_r_f2, property == "vm")$mm_vsris_rect[[1]]) +
  ggtitle("Fixed effects for membrane potential")

plotFE_sd(filter(data.sc_r_f2, property == "tau")$mm_vsris_rect[[1]]) +
  ggtitle("Fixed effects for membrane time constant")

plotFE_sd(filter(data.sc_r_f2, property == "spkhlf")$mm_vsris_rect[[1]]) +
  ggtitle("Fixed effects for spike half-width")
```

## Do random effects remain significant in a model with additional fixed effects included?
Fit mixed model including dvloc, age, expr, rectime, housing as fixed effects, and equivalent linear model.
```{r}
data.sc_r_f2_all <- data.sc_r_f2 %>%
  select(property, data) %>%
  mutate(mm_full_fixed = map(data, model_vsris_full_fixed),
         mm_full_fixed_linear = map(data, model_vsris_full_fixed_linear))
```

Carry out ANOVA to evaluate effects within the full model.
```{r}
update.2 <- function(mod) {update(mod, REML = TRUE)}
car.ANOVA <- function(fit) {car::Anova(fit, type="II",test.statistic="F")}
data.sc_r_f2_all <- data.sc_r_f2_all %>%
  mutate(m.reml = map(mm_full_fixed, update.2),
         ANOVA = map(m.reml, car.ANOVA))
```

Compare the full mixed with the equivalent linear model.
```{r}
data.sc_r_f2_all <- mixed_vs_linear_pchisqu(data.sc_r_f2_all,
                                         mm_full_fixed,
                                         mm_full_fixed_linear)
```

Make table to summarise comparison of the full mixed with the equivalent linear model.
```{r}
data.sc_r_f2_all$mm_full_fixed_vslinear_pdiff_adj <- p.adjust(data.sc_r_f2_all$mm_full_fixed_vslinear_pdiff, method = "BH")
table_mixedvslinear(data.sc_r_f2_all, "mm_full_fixed_vslinear")
```


## Do random effects remain significant in a minimal model?

Rationale is to remove factors above identified as contributing to variability between animals, account for factors that contribute to variability within animals, and then test for whether mixed model still gives a better account of the data than a linear model.

Test 1. Focus on mice aged above P32 and below P45, housed in a standard homecage, with exclusively medial slices and exclusively experiments by HP. 

```{r}
filter_test1 <- function(df) {
  dplyr::filter(df, age > 32 & age <45 & housing == "Standard" & mlpos == "Medial" & expr == "HP")
}

data.sc_r_f2 <- data.sc_r_f2 %>%
  mutate(data_test1 = map(data, filter_test1),
         mm_min1 = map(data_test1, model_vsris),
         lin_min1 = map(data_test1, linearmodel_to_fit))
```

Compare the full mixed with the equivalent linear model.
```{r}
data.sc_r_f2 <- mixed_vs_linear_pchisqu(data.sc_r_f2,
                                         mm_min1,
                                         lin_min1)

data.sc_r_f2$mm_min1_vslinear_pdiff_adj <- p.adjust(data.sc_r_f2$mm_min1_vslinear_pdiff, method = "BH")

table_mixedvslinear(data.sc_r_f2, "mm_min1_vslinear")
```


Test 2. Focus on mice aged above P32 and below P45, housed in a standard homecage, with exclusively lateral slices and exclusively experiments by HP. 

```{r}
filter_test1 <- function(df) {
  dplyr::filter(df, age > 32 & age <45 & housing == "Standard" & mlpos == "Lateral" & expr == "HP")
}

data.sc_r_f2 <- data.sc_r_f2 %>%
  mutate(data_test1 = map(data, filter_test1),
         mm_min1 = map(data_test1, model_vsris),
         lin_min1 = map(data_test1, linearmodel_to_fit))
```

Compare the full mixed with the equivalent linear model.
```{r}
data.sc_r_f2 <- mixed_vs_linear_pchisqu(data.sc_r_f2,
                                         mm_min1,
                                         lin_min1)

data.sc_r_f2$mm_min1_vslinear_pdiff_adj <- p.adjust(data.sc_r_f2$mm_min1_vslinear_pdiff, method = "BH")

table_mixedvslinear(data.sc_r_f2, "mm_min1_vslinear")
```
